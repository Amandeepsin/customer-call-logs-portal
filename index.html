<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Service Ticketing Portal</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #fff;
            min-height: 100vh;
        }
        .header {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(71, 85, 105, 0.5);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 1.5rem; font-weight: 700; }
        .header-right { display: flex; gap: 1rem; align-items: center; }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: rgba(71, 85, 105, 0.6); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.75rem; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { 
            display: block; 
            margin-bottom: 0.5rem; 
            color: #cbd5e1; 
            font-size: 0.875rem;
            font-weight: 600;
        }
        .form-control, .form-select, .form-textarea {
            width: 100%;
            padding: 0.875rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }
        .form-control:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-control.error, .form-select.error, .form-textarea.error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15) !important;
            animation: shake 0.3s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .toggle-btn.error {
            border-color: #ef4444 !important;
            animation: pulse 0.5s;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .form-textarea { resize: vertical; min-height: 100px; font-family: inherit; }
        .yes-no-buttons {
            display: flex;
            gap: 1rem;
        }
        .toggle-btn {
            flex: 1;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.4);
            border: 2px solid rgba(71, 85, 105, 0.5);
            border-radius: 8px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
        }
        .toggle-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        .toggle-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: white;
        }
        .reason-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .reason-option {
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.4);
            border: 2px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .reason-option:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        .reason-option.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        .reason-option h3 { margin-bottom: 0.5rem; font-size: 1.125rem; }
        .reason-option p { font-size: 0.875rem; color: #94a3b8; }
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .alert-success { background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.5); color: #10b981; }
        .alert-error { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; }
        .alert-info { background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); color: #60a5fa; }
        .alert-warning { background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.5); color: #fbbf24; }
        .alert-next-steps {
            background: rgba(16, 185, 129, 0.15);
            border: 2px solid rgba(16, 185, 129, 0.6);
            color: #10b981;
            padding: 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }
        .alert-next-steps strong {
            display: block;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: #10b981;
            font-weight: 700;
        }
        .alert-next-steps ul {
            margin: 0.5rem 0 0 1.5rem;
            color: #cbd5e1;
        }
        .alert-next-steps li {
            margin: 0.5rem 0;
            line-height: 1.5;
        }
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(71, 85, 105, 0.5);
        }
        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab:hover { color: white; }
        .tab.active {
            color: white;
            border-bottom-color: #3b82f6;
        }
        table { width: 100%; border-collapse: collapse; }
        th { 
            background: rgba(30, 41, 59, 0.8); 
            padding: 1rem; 
            text-align: left; 
            font-weight: 600; 
            font-size: 0.875rem;
            border-bottom: 2px solid rgba(71, 85, 105, 0.5);
        }
        td { 
            padding: 1rem; 
            border-bottom: 1px solid rgba(71, 85, 105, 0.3); 
            font-size: 0.875rem;
        }
        .badge { 
            display: inline-block; 
            padding: 0.375rem 0.875rem; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
            font-weight: 600;
        }
        .badge-pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .badge-resolved { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-escalated { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 1rem; 
            margin-bottom: 2rem;
        }
        .stat-card {
            padding: 1.5rem;
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        .stat-value { 
            font-size: 2.5rem; 
            font-weight: 700; 
            margin: 0.5rem 0;
        }
        .stat-label { 
            font-size: 0.875rem; 
            color: #94a3b8;
            font-weight: 500;
        }
        .role-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            max-width: 800px;
            margin: 4rem auto;
        }
        .role-card {
            padding: 3rem;
            background: rgba(30, 41, 59, 0.7);
            border: 2px solid rgba(71, 85, 105, 0.5);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .role-card:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-4px);
        }
        .role-card h2 { margin-top: 1rem; font-size: 1.5rem; }
        .role-card p { margin-top: 0.5rem; color: #94a3b8; }
        .icon-large {
            width: 64px;
            height: 64px;
            margin: 0 auto;
            opacity: 0.8;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .step-indicator {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            font-weight: 600;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s;
        }
        .ticket-detail {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .ticket-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }
        .ticket-detail-row:last-child {
            border-bottom: none;
        }
        .ticket-detail-label {
            font-weight: 600;
            color: #94a3b8;
        }
        .ticket-detail-value {
            color: white;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal-content {
            background: #1e293b;
            border-radius: 12px;
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDlBD0g4nBLXAzG1xV-sQp6VHdKxdwWsuk",
            authDomain: "employee-management-36cb3.firebaseapp.com",
            projectId: "employee-management-36cb3",
            storageBucket: "employee-management-36cb3.firebasestorage.app",
            messagingSenderId: "564697114640",
            appId: "1:564697114640:web:6d6d0c96d02e4e6b4a2ecc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const COUNTRIES = [
            'India',
            'United States',
            'Canada',
            'United Kingdom',
            'Australia',
            'Germany',
            'France',
            'Other'
        ];
        
        const CURRENCY_MAP = {
            'India': { symbol: '‚Çπ', code: 'INR' },
            'United States': { symbol: '$', code: 'USD' },
            'Canada': { symbol: 'C$', code: 'CAD' },
            'United Kingdom': { symbol: '¬£', code: 'GBP' },
            'Australia': { symbol: 'A$', code: 'AUD' },
            'Germany': { symbol: '‚Ç¨', code: 'EUR' },
            'France': { symbol: '‚Ç¨', code: 'EUR' },
            'Other': { symbol: '$', code: 'USD' }
        };
        
        function App() {
            const [view, setView] = useState('roleSelect');
            const [tickets, setTickets] = useState([]);
            const [loading, setLoading] = useState(false);
            
            // Agent authentication
            const [agentUsername, setAgentUsername] = useState('');
            const [agentLoginInput, setAgentLoginInput] = useState('');
            const [agentPassword, setAgentPassword] = useState('');
            const [loginError, setLoginError] = useState('');
            const [loginLoading, setLoginLoading] = useState(false);
            
            // Agent ticket history
            const [agentView, setAgentView] = useState('newTicket'); // 'newTicket' or 'history'
            const [agentTickets, setAgentTickets] = useState([]);
            const [editingTicket, setEditingTicket] = useState(null);
            
            // Manager filters and search
            const [searchQuery, setSearchQuery] = useState('');
            const [filterCountry, setFilterCountry] = useState('All');
            const [filterDate, setFilterDate] = useState('All');
            const [sortOrder, setSortOrder] = useState('newest');
            
            // Form state
            const [step, setStep] = useState(1);
            const [orderPlaced, setOrderPlaced] = useState(null);
            const [country, setCountry] = useState('');
            const [orderNumber, setOrderNumber] = useState('');
            const [phoneNumber, setPhoneNumber] = useState('');
            const [reasonForCall, setReasonForCall] = useState(null);
            
            // Add/Remove Items flow
            const [orderShipped, setOrderShipped] = useState(null);
            const [refundRequired, setRefundRequired] = useState(null);
            const [refundAmount, setRefundAmount] = useState('');
            const [additionalPaymentRequired, setAdditionalPaymentRequired] = useState(null);
            const [invoiceSent, setInvoiceSent] = useState(false);
            
            // Change Order Details flow
            const [orderDetailsChanged, setOrderDetailsChanged] = useState(null);
            
            // Order Tracking flow
            const [trackingStatus, setTrackingStatus] = useState(null);
            const [estimatedETA, setEstimatedETA] = useState('');
            const [customerSatisfied, setCustomerSatisfied] = useState(null);
            
            // Order Delivered Problem flow
            const [problemType, setProblemType] = useState(null);
            const [videoReceived, setVideoReceived] = useState(false);
            
            // General Inquiry flow
            const [generalQuery, setGeneralQuery] = useState('');
            const [resolutionNotes, setResolutionNotes] = useState('');
            const [generalStatus, setGeneralStatus] = useState(null);
            
            // Common fields
            const [agentNotes, setAgentNotes] = useState('');
            const [successMessage, setSuccessMessage] = useState('');
            const [errorMessage, setErrorMessage] = useState('');
            const [errorFields, setErrorFields] = useState([]);
            
            // Manager view
            const [managerTab, setManagerTab] = useState('escalated');
            const [selectedTicket, setSelectedTicket] = useState(null);
            const [managerResolutionNotes, setManagerResolutionNotes] = useState('');
            
            useEffect(() => {
                if (view === 'manager') {
                    loadTickets();
                }
            }, [view]);
            
            const loadTickets = async () => {
                try {
                    const snapshot = await db.collection('customerServiceTickets')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const ticketsData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Filter out resolved tickets older than 30 days
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const filteredTickets = ticketsData.filter(ticket => {
                        // Keep all non-resolved tickets (escalated, pending, etc.)
                        if (ticket.status !== 'resolved') {
                            return true;
                        }
                        
                        // For resolved tickets, only keep those from last 30 days
                        if (ticket.timestamp) {
                            const ticketDate = new Date(ticket.timestamp);
                            return ticketDate >= thirtyDaysAgo;
                        }
                        
                        // If no timestamp, keep it (safety fallback)
                        return true;
                    });
                    
                    setTickets(filteredTickets);
                } catch (error) {
                    console.error('Error loading tickets:', error);
                }
            };
            
            const loadAgentTickets = async () => {
                if (!agentUsername) return;
                
                try {
                    const snapshot = await db.collection('customerServiceTickets')
                        .where('agentUsername', '==', agentUsername)
                        .get();
                    
                    const ticketsData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Sort by timestamp in JavaScript (newest first)
                    ticketsData.sort((a, b) => {
                        const dateA = new Date(a.timestamp || 0);
                        const dateB = new Date(b.timestamp || 0);
                        return dateB - dateA; // Newest first
                    });
                    
                    setAgentTickets(ticketsData);
                } catch (error) {
                    console.error('Error loading agent tickets:', error);
                    alert('Error loading tickets: ' + error.message);
                }
            };
            
            const resetForm = () => {
                setStep(1);
                setOrderPlaced(null);
                setCountry('');
                setOrderNumber('');
                setPhoneNumber('');
                setReasonForCall(null);
                setOrderShipped(null);
                setRefundRequired(null);
                setRefundAmount('');
                setAdditionalPaymentRequired(null);
                setInvoiceSent(false);
                setOrderDetailsChanged(null);
                setTrackingStatus(null);
                setEstimatedETA('');
                setCustomerSatisfied(null);
                setProblemType(null);
                setVideoReceived(false);
                setGeneralQuery('');
                setResolutionNotes('');
                setGeneralStatus(null);
                setAgentNotes('');
            };
            
            const getProgress = () => {
                if (orderPlaced === null) return 25;
                if (orderPlaced === false && !generalQuery) return 50;
                if (orderPlaced === false && generalQuery && !resolutionNotes) return 75;
                if (orderPlaced === true && !reasonForCall) return 50;
                if (orderPlaced === true && reasonForCall) return 75;
                return 90;
            };
            
            // Get currency symbol based on selected country
            const getCurrencySymbol = () => {
                if (!country) return '$';
                return CURRENCY_MAP[country]?.symbol || '$';
            };
            
            // Determine if ticket will be escalated or resolved
            const getTicketStatus = () => {
                if (!orderPlaced && !generalQuery) return null;
                
                if (orderPlaced === true) {
                    if (reasonForCall === 'add_remove') {
                        if (orderShipped === true) return 'resolved'; // Can't modify shipped
                        if (orderShipped === false && refundRequired === true) return 'escalated'; // Refund needs approval
                        return 'resolved';
                    } else if (reasonForCall === 'change_details') {
                        if (orderShipped === true) return 'escalated'; // Shipped orders need escalation
                        return 'resolved';
                    } else if (reasonForCall === 'tracking') {
                        if (trackingStatus === 'shipped_not_delivered') return 'escalated'; // Needs investigation
                        if (trackingStatus === 'not_shipped' && customerSatisfied === false) return 'escalated'; // Wants refund
                        return 'resolved';
                    } else if (reasonForCall === 'problem_delivered') {
                        return 'escalated'; // Always escalated
                    }
                } else {
                    // General inquiry
                    if (generalStatus === 'escalate') return 'escalated';
                    return 'resolved';
                }
                
                return null;
            };
            
            // Get submit button text based on ticket status
            const getSubmitButtonText = () => {
                const status = getTicketStatus();
                if (loading) return 'Submitting...';
                if (status === 'escalated') return 'Submit & Escalate to Manager';
                if (status === 'resolved') return 'Submit & Mark Resolved';
                return 'Submit Ticket';
            };
            
            const handleSubmitTicket = async () => {
                // Clear previous errors
                setErrorFields([]);
                const errors = [];
                
                // Comprehensive validation
                if (!phoneNumber.trim()) {
                    setErrorMessage('Please enter phone number');
                    errors.push('phoneNumber');
                    setTimeout(() => setErrorMessage(''), 3000);
                    setErrorFields(errors);
                    return;
                }
                
                if (!country) {
                    setErrorMessage('Please select country');
                    errors.push('country');
                    setTimeout(() => setErrorMessage(''), 3000);
                    setErrorFields(errors);
                    return;
                }
                
                if (orderPlaced === null) {
                    setErrorMessage('Please select if order was placed');
                    setTimeout(() => setErrorMessage(''), 3000);
                    return;
                }
                
                if (orderPlaced === true) {
                    if (!orderNumber.trim()) {
                        setErrorMessage('Please enter order number');
                        errors.push('orderNumber');
                        setTimeout(() => setErrorMessage(''), 3000);
                        setErrorFields(errors);
                        return;
                    }
                    
                    if (!reasonForCall) {
                        setErrorMessage('Please select reason for calling');
                        setTimeout(() => setErrorMessage(''), 3000);
                        return;
                    }
                    
                    // Validate based on reason for call
                    if (reasonForCall === 'add_remove') {
                        if (orderShipped === null) {
                            setErrorMessage('Please specify if order has shipped');
                            setTimeout(() => setErrorMessage(''), 3000);
                            return;
                        }
                        
                        if (orderShipped === false) {
                            if (refundRequired === null) {
                                setErrorMessage('Please specify if refund is required');
                                setTimeout(() => setErrorMessage(''), 3000);
                                return;
                            }
                            
                            if (refundRequired === true && !refundAmount.trim()) {
                                setErrorMessage('Please enter refund amount');
                                setTimeout(() => setErrorMessage(''), 3000);
                                return;
                            }
                            
                            if (additionalPaymentRequired === null) {
                                setErrorMessage('Please specify if additional payment is required');
                                setTimeout(() => setErrorMessage(''), 3000);
                                return;
                            }
                        }
                    } else if (reasonForCall === 'change_details') {
                        if (orderShipped === null) {
                            setErrorMessage('Please specify if order has shipped');
                            setTimeout(() => setErrorMessage(''), 3000);
                            return;
                        }
                        
                        if (orderShipped === false && orderDetailsChanged === null) {
                            setErrorMessage('Please specify if order details were changed');
                            setTimeout(() => setErrorMessage(''), 3000);
                            return;
                        }
                    } else if (reasonForCall === 'tracking') {
                        if (!trackingStatus) {
                            setErrorMessage('Please select tracking status');
                            setTimeout(() => setErrorMessage(''), 3000);
                            return;
                        }
                        
                        if (trackingStatus === 'not_shipped') {
                            if (!estimatedETA.trim()) {
                                setErrorMessage('Please enter estimated ETA');
                                setTimeout(() => setErrorMessage(''), 3000);
                                return;
                            }
                            
                            if (customerSatisfied === null) {
                                setErrorMessage('Please specify if customer is satisfied');
                                setTimeout(() => setErrorMessage(''), 3000);
                                return;
                            }
                        }
                    } else if (reasonForCall === 'problem_delivered') {
                        if (!problemType) {
                            setErrorMessage('Please select problem type');
                            setTimeout(() => setErrorMessage(''), 3000);
                            return;
                        }
                        
                        if (!videoReceived) {
                            setErrorMessage('Please confirm that order opening video has been received via email');
                            setTimeout(() => setErrorMessage(''), 3000);
                            return;
                        }
                    }
                } else {
                    // General Inquiry validation
                    if (!generalQuery.trim()) {
                        setErrorMessage('Please enter the customer query');
                        setTimeout(() => setErrorMessage(''), 3000);
                        return;
                    }
                    
                    if (!resolutionNotes.trim()) {
                        setErrorMessage('Please enter how you resolved the query');
                        setTimeout(() => setErrorMessage(''), 3000);
                        return;
                    }
                    
                    if (!generalStatus) {
                        setErrorMessage('Please select status (Resolved or Escalate)');
                        setTimeout(() => setErrorMessage(''), 3000);
                        return;
                    }
                }
                
                // Validate conversation summary / additional notes (required for all tickets)
                if (!agentNotes.trim()) {
                    setErrorMessage('Please provide a conversation summary in Additional Notes');
                    errors.push('agentNotes');
                    setTimeout(() => setErrorMessage(''), 3000);
                    setErrorFields(errors);
                    return;
                }
                
                setLoading(true);
                
                try {
                    const ticketData = {
                        orderPlaced,
                        country,
                        orderNumber: orderNumber || 'N/A',
                        phoneNumber,
                        timestamp: new Date().toISOString(),
                        agentNotes,
                        agentUsername: agentUsername // Track which agent created the ticket
                    };
                    
                    // Try to add server timestamp, but don't fail if permissions don't allow it
                    try {
                        ticketData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    } catch (e) {
                        ticketData.createdAt = new Date().toISOString();
                    }
                    
                    if (orderPlaced) {
                        ticketData.reasonForCall = reasonForCall;
                        
                        if (reasonForCall === 'add_remove') {
                            ticketData.orderShipped = orderShipped;
                            
                            if (orderShipped) {
                                ticketData.status = 'resolved';
                                ticketData.resolution = 'Customer informed that items cannot be added/removed from shipped orders';
                            } else {
                                ticketData.refundRequired = refundRequired;
                                
                                if (refundRequired) {
                                    ticketData.status = 'escalated';
                                    ticketData.refundAmount = parseFloat(refundAmount);
                                    ticketData.resolution = 'Order edited in Shopify - Refund required';
                                } else {
                                    ticketData.status = 'resolved';
                                    ticketData.resolution = 'Order edited in Shopify successfully';
                                }
                                
                                ticketData.additionalPaymentRequired = additionalPaymentRequired;
                                if (additionalPaymentRequired) {
                                    ticketData.invoiceSent = invoiceSent;
                                }
                            }
                        } else if (reasonForCall === 'change_details') {
                            ticketData.orderShipped = orderShipped;
                            
                            if (orderShipped) {
                                ticketData.status = 'escalated';
                                ticketData.resolution = 'Order already shipped - Customer needs assistance with details change';
                            } else {
                                ticketData.orderDetailsChanged = orderDetailsChanged;
                                ticketData.status = 'resolved';
                                ticketData.resolution = orderDetailsChanged 
                                    ? 'Customer updated details via email link'
                                    : 'Agent updated details in Shopify';
                            }
                        } else if (reasonForCall === 'tracking') {
                            ticketData.trackingStatus = trackingStatus;
                            
                            if (trackingStatus === 'shipped_not_delivered') {
                                ticketData.status = 'escalated';
                                ticketData.resolution = 'Order shipped but not delivered - needs investigation';
                            } else if (trackingStatus === 'not_shipped') {
                                ticketData.estimatedETA = estimatedETA;
                                ticketData.customerSatisfied = customerSatisfied;
                                
                                if (customerSatisfied) {
                                    ticketData.status = 'resolved';
                                    ticketData.resolution = `Customer satisfied with ETA: ${estimatedETA}`;
                                } else {
                                    ticketData.status = 'escalated';
                                    ticketData.resolution = 'Customer not satisfied - wants refund';
                                }
                            }
                        } else if (reasonForCall === 'problem_delivered') {
                            ticketData.problemType = problemType;
                            ticketData.videoReceived = videoReceived;
                            ticketData.status = 'escalated';
                            ticketData.resolution = problemType === 'missing_wrong' 
                                ? 'Missing or wrong item in order - Order opening video received'
                                : 'Whole order wrong - Order opening video received';
                        }
                    } else {
                        // General Inquiry
                        ticketData.generalQuery = generalQuery;
                        ticketData.resolutionNotes = resolutionNotes;
                        ticketData.status = generalStatus === 'escalate' ? 'escalated' : 'resolved';
                        ticketData.resolution = resolutionNotes;
                    }
                    
                    await db.collection('customerServiceTickets').add(ticketData);
                    
                    setSuccessMessage('Ticket submitted successfully!');
                    setTimeout(() => setSuccessMessage(''), 3000);
                    resetForm();
                } catch (error) {
                    console.error('Error submitting ticket:', error);
                    console.error('Error details:', error.code, error.message);
                    
                    // Show detailed error message
                    let errorMsg = 'Error submitting ticket. ';
                    if (error.code === 'permission-denied') {
                        errorMsg += 'Permission denied. Please check Firebase security rules.';
                    } else if (error.message) {
                        errorMsg += error.message;
                    } else {
                        errorMsg += 'Please try again.';
                    }
                    
                    setErrorMessage(errorMsg);
                    setTimeout(() => setErrorMessage(''), 5000);
                } finally {
                    setLoading(false);
                }
            };
            
            const updateTicketStatus = async (ticketId, newStatus, managerNotes = '') => {
                try {
                    await db.collection('customerServiceTickets').doc(ticketId).update({
                        status: newStatus,
                        managerNotes,
                        resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    loadTickets();
                    setSelectedTicket(null);
                } catch (error) {
                    console.error('Error updating ticket:', error);
                }
            };
            
            const handleAgentLogin = async (e) => {
                e.preventDefault();
                setLoginError('');
                setLoginLoading(true);
                
                try {
                    const username = agentLoginInput.trim();
                    const password = agentPassword.trim();
                    
                    if (!username || !password) {
                        setLoginError('Please enter both username and password');
                        setLoginLoading(false);
                        return;
                    }
                    
                    // Check credentials against employees collection in Firebase
                    const employeesSnapshot = await db.collection('employees')
                        .where('username', '==', username)
                        .get();
                    
                    if (employeesSnapshot.empty) {
                        setLoginError('Invalid username or password');
                        setLoginLoading(false);
                        return;
                    }
                    
                    const employeeDoc = employeesSnapshot.docs[0];
                    const employee = employeeDoc.data();
                    
                    // Verify password
                    if (employee.password !== password) {
                        setLoginError('Invalid username or password');
                        setLoginLoading(false);
                        return;
                    }
                    
                    // Login successful
                    setAgentUsername(employee.name || username);
                    setLoginError('');
                } catch (error) {
                    console.error('Login error:', error);
                    setLoginError('Login failed. Please try again.');
                } finally {
                    setLoginLoading(false);
                }
            };
            
            const handleAgentLogout = () => {
                setAgentUsername('');
                setAgentLoginInput('');
                setAgentPassword('');
                setView('roleSelect');
                resetForm();
            };
            
            // Filter tickets based on search and filters
            const getFilteredTickets = () => {
                let filtered = tickets;
                
                // Filter by tab
                if (managerTab === 'escalated') {
                    filtered = filtered.filter(t => t.status === 'escalated');
                } else if (managerTab === 'resolved') {
                    filtered = filtered.filter(t => t.status === 'resolved');
                } else if (managerTab === 'pending') {
                    filtered = filtered.filter(t => t.status === 'pending');
                }
                
                // Filter by search query
                if (searchQuery.trim()) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(t => 
                        (t.orderNumber && t.orderNumber.toLowerCase().includes(query)) ||
                        (t.phoneNumber && t.phoneNumber.includes(query)) ||
                        (t.agentUsername && t.agentUsername.toLowerCase().includes(query)) ||
                        (t.agentNotes && t.agentNotes.toLowerCase().includes(query))
                    );
                }
                
                // Filter by country
                if (filterCountry !== 'All') {
                    filtered = filtered.filter(t => t.country === filterCountry);
                }
                
                // Filter by date
                if (filterDate !== 'All') {
                    const now = new Date();
                    filtered = filtered.filter(t => {
                        const ticketDate = new Date(t.timestamp);
                        const diffDays = Math.floor((now - ticketDate) / (1000 * 60 * 60 * 24));
                        
                        if (filterDate === 'Today') return diffDays === 0;
                        if (filterDate === 'Yesterday') return diffDays === 1;
                        if (filterDate === 'Last 7 Days') return diffDays <= 7;
                        if (filterDate === 'Last 30 Days') return diffDays <= 30;
                        return true;
                    });
                }
                
                // Sort tickets
                filtered.sort((a, b) => {
                    const dateA = new Date(a.timestamp || 0);
                    const dateB = new Date(b.timestamp || 0);
                    
                    if (sortOrder === 'newest') {
                        return dateB - dateA; // Newest first
                    } else {
                        return dateA - dateB; // Oldest first
                    }
                });
                
                return filtered;
            };
            
            // Role Selection View
            if (view === 'roleSelect') {
                return (
                    <div>
                        <div className="header">
                            <h1>Customer Service Ticketing Portal</h1>
                        </div>
                        <div className="container">
                            <div className="role-selector">
                                <div className="role-card" onClick={() => setView('agent')}>
                                    <svg className="icon-large" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                    </svg>
                                    <h2>Agent</h2>
                                    <p>Create customer service tickets</p>
                                </div>
                                <div className="role-card" onClick={() => setView('manager')}>
                                    <svg className="icon-large" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                    <h2>Manager</h2>
                                    <p>Review & resolve escalated tickets</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Agent View
            if (view === 'agent') {
                // If agent not logged in, show login screen
                if (!agentUsername) {
                    return (
                        <div>
                            <div className="header">
                                <h1>Agent Login</h1>
                                <div className="header-right">
                                    <button className="btn btn-secondary" onClick={() => setView('roleSelect')}>
                                        Back
                                    </button>
                                </div>
                            </div>
                            <div className="container">
                                <div style={{maxWidth: '500px', margin: '0 auto', padding: '2rem'}}>
                                    <div className="card">
                                        <h2 style={{marginBottom: '1.5rem', textAlign: 'center'}}>Agent Login</h2>
                                        <form onSubmit={handleAgentLogin}>
                                            <div className="form-group">
                                                <label>Username *</label>
                                                <input
                                                    type="text"
                                                    className="form-control"
                                                    value={agentLoginInput}
                                                    onChange={(e) => setAgentLoginInput(e.target.value)}
                                                    placeholder="Enter your username"
                                                    autoFocus
                                                    required
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Password *</label>
                                                <input
                                                    type="password"
                                                    className="form-control"
                                                    value={agentPassword}
                                                    onChange={(e) => setAgentPassword(e.target.value)}
                                                    placeholder="Enter your password"
                                                    required
                                                />
                                            </div>
                                            {loginError && (
                                                <div className="alert alert-error" style={{marginTop: '1rem'}}>
                                                    ‚ö†Ô∏è {loginError}
                                                </div>
                                            )}
                                            <button 
                                                type="submit" 
                                                className="btn btn-primary" 
                                                style={{width: '100%', marginTop: '1.5rem'}}
                                                disabled={loginLoading}
                                            >
                                                {loginLoading ? 'Logging in...' : 'Login'}
                                            </button>
                                        </form>
                                        <p style={{textAlign: 'center', color: '#94a3b8', fontSize: '0.875rem', marginTop: '1.5rem'}}>
                                            üîí Same credentials as main employee portal
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // Agent is logged in, show ticket creation form
                return (
                    <div>
                        <div className="header">
                            <h1>{agentView === 'newTicket' ? 'Agent - New Ticket' : 'Agent - Ticket History'}</h1>
                            <div className="header-right">
                                <span style={{color: '#cbd5e1', marginRight: '1rem'}}>
                                    üë§ {agentUsername}
                                </span>
                                <button 
                                    className="btn btn-secondary" 
                                    onClick={() => {
                                        if (agentView === 'newTicket') {
                                            loadAgentTickets();
                                            setAgentView('history');
                                        } else {
                                            setAgentView('newTicket');
                                        }
                                    }}
                                    style={{marginRight: '1rem'}}
                                >
                                    {agentView === 'newTicket' ? 'üìã Ticket History' : '‚ûï New Ticket'}
                                </button>
                                <button className="btn btn-secondary" onClick={handleAgentLogout}>
                                    Logout
                                </button>
                            </div>
                        </div>
                        
                        {agentView === 'newTicket' ? (
                        <div className="container">
                            {successMessage && (
                                <div className="alert alert-success">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"></path>
                                    </svg>
                                    {successMessage}
                                </div>
                            )}
                            
                            {errorMessage && (
                                <div className="alert alert-error">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd"></path>
                                    </svg>
                                    {errorMessage}
                                </div>
                            )}
                            
                            <div className="progress-bar">
                                <div className="progress-fill" style={{width: `${getProgress()}%`}}></div>
                            </div>
                            
                            <div className="card">
                                <div className="step-indicator">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd"></path>
                                    </svg>
                                    How may I help you?
                                </div>
                                
                                {/* Step 1: Basic Information */}
                                <div className="grid-2">
                                    <div className="form-group">
                                        <label>Phone Number *</label>
                                        <input
                                            type="tel"
                                            className={`form-control ${errorFields.includes('phoneNumber') ? 'error' : ''}`}
                                            value={phoneNumber}
                                            onChange={(e) => {
                                                setPhoneNumber(e.target.value);
                                                setErrorFields(errorFields.filter(f => f !== 'phoneNumber'));
                                            }}
                                            placeholder="Enter customer phone number"
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label>Country of Order *</label>
                                        <select
                                            className={`form-select ${errorFields.includes('country') ? 'error' : ''}`}
                                            value={country}
                                            onChange={(e) => {
                                                setCountry(e.target.value);
                                                setErrorFields(errorFields.filter(f => f !== 'country'));
                                            }}
                                        >
                                            <option value="">Select country...</option>
                                            {COUNTRIES.map(c => (
                                                <option key={c} value={c}>{c}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                
                                {/* Step 2: Order Placed? */}
                                <div className="form-group">
                                    <label>Has the customer already placed an order? *</label>
                                    <div className="yes-no-buttons">
                                        <button
                                            className={`toggle-btn ${orderPlaced === true ? 'active' : ''}`}
                                            onClick={() => {
                                                setOrderPlaced(true);
                                                setGeneralQuery('');
                                                setResolutionNotes('');
                                            }}
                                        >
                                            Yes - Order Placed
                                        </button>
                                        <button
                                            className={`toggle-btn ${orderPlaced === false ? 'active' : ''}`}
                                            onClick={() => {
                                                setOrderPlaced(false);
                                                setOrderNumber('');
                                                setReasonForCall(null);
                                            }}
                                        >
                                            No - General Inquiry
                                        </button>
                                    </div>
                                </div>
                                
                                {/* If Order Placed = Yes */}
                                {orderPlaced === true && (
                                    <>
                                        <div className="form-group">
                                            <label>Order Number *</label>
                                            <input
                                                type="text"
                                                className={`form-control ${errorFields.includes('orderNumber') ? 'error' : ''}`}
                                                value={orderNumber}
                                                onChange={(e) => {
                                                    setOrderNumber(e.target.value);
                                                    setErrorFields(errorFields.filter(f => f !== 'orderNumber'));
                                                }}
                                                placeholder="Enter order number"
                                            />
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>Reason for Calling *</label>
                                            <div className="reason-options">
                                                <div
                                                    className={`reason-option ${reasonForCall === 'add_remove' ? 'active' : ''}`}
                                                    onClick={() => setReasonForCall('add_remove')}
                                                >
                                                    <h3>Add/Remove Items</h3>
                                                    <p>Modify items in the order</p>
                                                </div>
                                                
                                                <div
                                                    className={`reason-option ${reasonForCall === 'change_details' ? 'active' : ''}`}
                                                    onClick={() => setReasonForCall('change_details')}
                                                >
                                                    <h3>Change Order Details</h3>
                                                    <p>Update shipping or contact info</p>
                                                </div>
                                                
                                                <div
                                                    className={`reason-option ${reasonForCall === 'tracking' ? 'active' : ''}`}
                                                    onClick={() => setReasonForCall('tracking')}
                                                >
                                                    <h3>Order Tracking</h3>
                                                    <p>Check delivery status</p>
                                                </div>
                                                
                                                <div
                                                    className={`reason-option ${reasonForCall === 'problem_delivered' ? 'active' : ''}`}
                                                    onClick={() => setReasonForCall('problem_delivered')}
                                                >
                                                    <h3>Problem with Delivered Order</h3>
                                                    <p>Wrong or missing items</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Add/Remove Items Flow */}
                                        {reasonForCall === 'add_remove' && (
                                            <>
                                                <div className="form-group">
                                                    <label>Has order already shipped? *</label>
                                                    <div className="yes-no-buttons">
                                                        <button
                                                            className={`toggle-btn ${orderShipped === true ? 'active' : ''}`}
                                                            onClick={() => setOrderShipped(true)}
                                                        >
                                                            Yes - Already Shipped
                                                        </button>
                                                        <button
                                                            className={`toggle-btn ${orderShipped === false ? 'active' : ''}`}
                                                            onClick={() => setOrderShipped(false)}
                                                        >
                                                            No - Not Shipped Yet
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                {orderShipped === true && (
                                                    <div className="alert alert-info">
                                                        ‚ÑπÔ∏è Customer informed that items cannot be added/removed from shipped orders. This will be marked as resolved.
                                                    </div>
                                                )}
                                                
                                                {orderShipped === false && (
                                                    <>
                                                        <div className="alert-next-steps">
                                                            <strong>üìã Next Steps</strong>
                                                            <ul>
                                                                <li>Open Shopify admin panel</li>
                                                                <li>Search for order number</li>
                                                                <li>Edit the order - add or remove items as requested</li>
                                                                <li>Save changes</li>
                                                            </ul>
                                                        </div>
                                                        
                                                        <div className="form-group">
                                                            <label>Is refund required after changes? *</label>
                                                            <div className="yes-no-buttons">
                                                                <button
                                                                    className={`toggle-btn ${refundRequired === true ? 'active' : ''}`}
                                                                    onClick={() => setRefundRequired(true)}
                                                                >
                                                                    Yes - Refund Needed
                                                                </button>
                                                                <button
                                                                    className={`toggle-btn ${refundRequired === false ? 'active' : ''}`}
                                                                    onClick={() => {
                                                                        setRefundRequired(false);
                                                                        setRefundAmount('');
                                                                    }}
                                                                >
                                                                    No Refund
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        {refundRequired === true && (
                                                            <div key={country}>
                                                                <div className="form-group">
                                                                    <label>Refund Amount ({getCurrencySymbol()}) *</label>
                                                                    <input
                                                                        type="number"
                                                                        step="0.01"
                                                                        className="form-control"
                                                                        value={refundAmount}
                                                                        onChange={(e) => setRefundAmount(e.target.value)}
                                                                        placeholder={`Enter refund amount in ${getCurrencySymbol()}`}
                                                                    />
                                                                </div>
                                                                <div className="alert alert-warning">
                                                                    ‚ö†Ô∏è Refund required - This will be escalated to manager for approval
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        <div className="form-group">
                                                            <label>Is additional payment required from customer? *</label>
                                                            <div className="yes-no-buttons">
                                                                <button
                                                                    className={`toggle-btn ${additionalPaymentRequired === true ? 'active' : ''}`}
                                                                    onClick={() => setAdditionalPaymentRequired(true)}
                                                                >
                                                                    Yes - Payment Needed
                                                                </button>
                                                                <button
                                                                    className={`toggle-btn ${additionalPaymentRequired === false ? 'active' : ''}`}
                                                                    onClick={() => {
                                                                        setAdditionalPaymentRequired(false);
                                                                        setInvoiceSent(false);
                                                                    }}
                                                                >
                                                                    No Payment Needed
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        {additionalPaymentRequired === true && (
                                                            <div className="form-group">
                                                                <label>
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={invoiceSent}
                                                                        onChange={(e) => setInvoiceSent(e.target.checked)}
                                                                        style={{marginRight: '0.5rem'}}
                                                                    />
                                                                    I have sent the invoice to the customer
                                                                </label>
                                                            </div>
                                                        )}
                                                    </>
                                                )}
                                            </>
                                        )}
                                        
                                        {/* Change Order Details Flow */}
                                        {reasonForCall === 'change_details' && (
                                            <>
                                                <div className="form-group">
                                                    <label>Has order already shipped? *</label>
                                                    <div className="yes-no-buttons">
                                                        <button
                                                            className={`toggle-btn ${orderShipped === true ? 'active' : ''}`}
                                                            onClick={() => setOrderShipped(true)}
                                                        >
                                                            Yes - Already Shipped
                                                        </button>
                                                        <button
                                                            className={`toggle-btn ${orderShipped === false ? 'active' : ''}`}
                                                            onClick={() => setOrderShipped(false)}
                                                        >
                                                            No - Not Shipped Yet
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                {orderShipped === true && (
                                                    <div className="alert alert-warning">
                                                        ‚ö†Ô∏è Order already shipped - Details cannot be changed. This will be escalated to manager for assistance.
                                                    </div>
                                                )}
                                                
                                                {orderShipped === false && (
                                                    <>
                                                        <div className="alert-next-steps">
                                                            <strong>üìã Next Steps</strong>
                                                            <ul>
                                                                <li>Instruct customer to open their confirmation email</li>
                                                                <li>Ask them to click the link to update details themselves</li>
                                                                <li>If customer cannot do it, update details in Shopify</li>
                                                            </ul>
                                                        </div>
                                                        
                                                        <div className="form-group">
                                                            <label>Did customer update details successfully? *</label>
                                                            <div className="yes-no-buttons">
                                                                <button
                                                                    className={`toggle-btn ${orderDetailsChanged === true ? 'active' : ''}`}
                                                                    onClick={() => setOrderDetailsChanged(true)}
                                                                >
                                                                    Yes - Customer Updated
                                                                </button>
                                                                <button
                                                                    className={`toggle-btn ${orderDetailsChanged === false ? 'active' : ''}`}
                                                                    onClick={() => setOrderDetailsChanged(false)}
                                                                >
                                                                    No - Agent Updated in Shopify
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </>
                                                )}
                                            </>
                                        )}
                                        
                                        {/* Order Tracking Flow */}
                                        {reasonForCall === 'tracking' && (
                                            <>
                                                <div className="form-group">
                                                    <label>Has order already shipped? *</label>
                                                    <div className="reason-options">
                                                        <div
                                                            className={`reason-option ${trackingStatus === 'shipped_not_delivered' ? 'active' : ''}`}
                                                            onClick={() => setTrackingStatus('shipped_not_delivered')}
                                                        >
                                                            <h3>Yes - Shipped but Not Delivered</h3>
                                                            <p>Order is in transit</p>
                                                        </div>
                                                        
                                                        <div
                                                            className={`reason-option ${trackingStatus === 'not_shipped' ? 'active' : ''}`}
                                                            onClick={() => setTrackingStatus('not_shipped')}
                                                        >
                                                            <h3>No - Not Shipped Yet</h3>
                                                            <p>Still processing</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {trackingStatus === 'shipped_not_delivered' && (
                                                    <div className="alert alert-warning">
                                                        ‚ö†Ô∏è Order shipped but not delivered. This will be escalated to manager for investigation.
                                                    </div>
                                                )}
                                                
                                                {trackingStatus === 'not_shipped' && (
                                                    <>
                                                        <div className="form-group">
                                                            <label>Estimated ETA of Shipping/Delivery *</label>
                                                            <input
                                                                type="text"
                                                                className="form-control"
                                                                value={estimatedETA}
                                                                onChange={(e) => setEstimatedETA(e.target.value)}
                                                                placeholder="e.g., 2-3 business days, January 15, etc."
                                                            />
                                                        </div>
                                                        
                                                        <div className="form-group">
                                                            <label>Is customer satisfied with the ETA? *</label>
                                                            <div className="yes-no-buttons">
                                                                <button
                                                                    className={`toggle-btn ${customerSatisfied === true ? 'active' : ''}`}
                                                                    onClick={() => setCustomerSatisfied(true)}
                                                                >
                                                                    Yes - Customer Satisfied
                                                                </button>
                                                                <button
                                                                    className={`toggle-btn ${customerSatisfied === false ? 'active' : ''}`}
                                                                    onClick={() => setCustomerSatisfied(false)}
                                                                >
                                                                    No - Wants Refund
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        {customerSatisfied === false && (
                                                            <div className="alert alert-warning">
                                                                ‚ö†Ô∏è Customer not satisfied and wants refund. This will be escalated to manager.
                                                            </div>
                                                        )}
                                                    </>
                                                )}
                                            </>
                                        )}
                                        
                                        {/* Problem with Delivered Order Flow */}
                                        {reasonForCall === 'problem_delivered' && (
                                            <>
                                                <div className="form-group">
                                                    <label>Type of Problem *</label>
                                                    <div className="reason-options">
                                                        <div
                                                            className={`reason-option ${problemType === 'missing_wrong' ? 'active' : ''}`}
                                                            onClick={() => setProblemType('missing_wrong')}
                                                        >
                                                            <h3>Missing/Wrong Item</h3>
                                                            <p>Some items are missing or incorrect</p>
                                                        </div>
                                                        
                                                        <div
                                                            className={`reason-option ${problemType === 'whole_order_wrong' ? 'active' : ''}`}
                                                            onClick={() => setProblemType('whole_order_wrong')}
                                                        >
                                                            <h3>Whole Order Wrong</h3>
                                                            <p>Entire order is incorrect</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {problemType && (
                                                    <>
                                                        <div className="alert-next-steps">
                                                            <strong>üìã Next Steps</strong>
                                                            <ul>
                                                                <li>Ask customer to record a video while opening the order package</li>
                                                                <li>Request customer to send the video via email</li>
                                                                <li>Once video is received, confirm below and escalate to manager</li>
                                                            </ul>
                                                        </div>
                                                        
                                                        <div className="form-group">
                                                            <label style={{display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '1rem', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '8px', cursor: 'pointer'}}>
                                                                <input
                                                                    type="checkbox"
                                                                    checked={videoReceived}
                                                                    onChange={(e) => setVideoReceived(e.target.checked)}
                                                                    style={{width: '20px', height: '20px', cursor: 'pointer'}}
                                                                />
                                                                <span style={{fontWeight: 600, color: '#cbd5e1'}}>
                                                                    ‚úÖ I confirm that order opening video has been received via email
                                                                </span>
                                                            </label>
                                                        </div>
                                                        
                                                        {videoReceived && (
                                                            <div className="alert alert-warning">
                                                                ‚ö†Ô∏è Video received - This issue will be escalated to manager for resolution.
                                                            </div>
                                                        )}
                                                    </>
                                                )}
                                            </>
                                        )}
                                    </>
                                )}
                                
                                {/* If Order Placed = No (General Inquiry) */}
                                {orderPlaced === false && (
                                    <>
                                        <div className="alert alert-info">
                                            ‚ÑπÔ∏è This will be categorized as a "General Inquiry"
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>What was the query? *</label>
                                            <textarea
                                                className="form-textarea"
                                                value={generalQuery}
                                                onChange={(e) => setGeneralQuery(e.target.value)}
                                                placeholder="Describe the customer's inquiry..."
                                                rows="4"
                                            />
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>How did you resolve it? *</label>
                                            <textarea
                                                className="form-textarea"
                                                value={resolutionNotes}
                                                onChange={(e) => setResolutionNotes(e.target.value)}
                                                placeholder="Describe the resolution provided..."
                                                rows="4"
                                            />
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>Status *</label>
                                            <div className="yes-no-buttons">
                                                <button
                                                    className={`toggle-btn ${generalStatus === 'resolved' ? 'active' : ''}`}
                                                    onClick={() => setGeneralStatus('resolved')}
                                                >
                                                    ‚úì Resolved
                                                </button>
                                                <button
                                                    className={`toggle-btn ${generalStatus === 'escalate' ? 'active' : ''}`}
                                                    onClick={() => setGeneralStatus('escalate')}
                                                >
                                                    ‚ö†Ô∏è Escalate to Manager
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                )}
                                
                                {/* Additional Agent Notes */}
                                <div className="form-group">
                                    <label>Conversation Summary / Additional Notes *</label>
                                    <textarea
                                        className={`form-textarea ${errorFields.includes('agentNotes') ? 'error' : ''}`}
                                        value={agentNotes}
                                        onChange={(e) => {
                                            setAgentNotes(e.target.value);
                                            setErrorFields(errorFields.filter(f => f !== 'agentNotes'));
                                        }}
                                        placeholder="Briefly explain the conversation: what the customer said, what you told them, any important details..."
                                        rows="4"
                                    />
                                    <p style={{fontSize: '0.75rem', color: '#94a3b8', marginTop: '0.5rem'}}>
                                        üí° This helps managers understand the full context of the call
                                    </p>
                                </div>
                                
                                {/* Submit Buttons */}
                                <div style={{marginTop: '2rem', display: 'flex', gap: '1rem'}}>
                                    <button
                                        className={`btn ${getTicketStatus() === 'escalated' ? 'btn-warning' : 'btn-success'}`}
                                        onClick={handleSubmitTicket}
                                        disabled={loading}
                                        style={{flex: 1}}
                                    >
                                        {getSubmitButtonText()}
                                    </button>
                                    <button
                                        className="btn btn-secondary"
                                        onClick={resetForm}
                                        disabled={loading}
                                    >
                                        Clear Form
                                    </button>
                                </div>
                            </div>
                        </div>
                        ) : (
                        <div className="container">
                            {/* Ticket History View */}
                            <div className="card">
                                <h2 style={{marginBottom: '1.5rem'}}>My Ticket History</h2>
                                
                                {agentTickets.length === 0 ? (
                                    <div style={{textAlign: 'center', padding: '3rem', color: '#94a3b8'}}>
                                        <svg style={{width: '64px', height: '64px', margin: '0 auto 1rem', opacity: 0.5}} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <p>No tickets found</p>
                                    </div>
                                ) : (
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date/Time</th>
                                                <th>Order #</th>
                                                <th>Phone</th>
                                                <th>Country</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {agentTickets.map(ticket => (
                                                <tr key={ticket.id}>
                                                    <td>
                                                        {ticket.timestamp ? new Date(ticket.timestamp).toLocaleString('en-US', {
                                                            month: 'short',
                                                            day: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        }) : 'N/A'}
                                                    </td>
                                                    <td style={{fontWeight: 600}}>{ticket.orderNumber}</td>
                                                    <td>{ticket.phoneNumber}</td>
                                                    <td>{ticket.country}</td>
                                                    <td>
                                                        {ticket.status === 'escalated' && <span className="badge badge-escalated">Escalated</span>}
                                                        {ticket.status === 'resolved' && <span className="badge badge-resolved">Resolved</span>}
                                                        {ticket.status === 'pending' && <span className="badge badge-pending">Pending</span>}
                                                    </td>
                                                    <td>
                                                        <button
                                                            className="btn btn-primary btn-sm"
                                                            onClick={() => setEditingTicket(ticket)}
                                                        >
                                                            View/Edit
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                            
                            {/* Edit Ticket Modal */}
                            {editingTicket && (
                                <div className="modal-overlay" onClick={() => setEditingTicket(null)}>
                                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '800px', maxHeight: '90vh', overflowY: 'auto'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem'}}>
                                            <h2 style={{fontSize: '1.5rem'}}>Edit Ticket</h2>
                                            <button
                                                onClick={() => setEditingTicket(null)}
                                                className="btn btn-secondary btn-sm"
                                            >
                                                Close
                                            </button>
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>Order Number</label>
                                            <input
                                                type="text"
                                                className="form-control"
                                                value={editingTicket.orderNumber}
                                                onChange={(e) => setEditingTicket({...editingTicket, orderNumber: e.target.value})}
                                            />
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>Phone Number</label>
                                            <input
                                                type="text"
                                                className="form-control"
                                                value={editingTicket.phoneNumber}
                                                onChange={(e) => setEditingTicket({...editingTicket, phoneNumber: e.target.value})}
                                            />
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>Country</label>
                                            <select
                                                className="form-select"
                                                value={editingTicket.country}
                                                onChange={(e) => setEditingTicket({...editingTicket, country: e.target.value})}
                                            >
                                                {COUNTRIES.map(c => (
                                                    <option key={c} value={c}>{c}</option>
                                                ))}
                                            </select>
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>Agent Notes / Conversation Summary</label>
                                            <textarea
                                                className="form-control"
                                                value={editingTicket.agentNotes}
                                                onChange={(e) => setEditingTicket({...editingTicket, agentNotes: e.target.value})}
                                                rows="5"
                                            />
                                        </div>
                                        
                                        <div style={{display: 'flex', gap: '1rem', marginTop: '1.5rem'}}>
                                            <button
                                                className="btn btn-primary"
                                                onClick={async () => {
                                                    try {
                                                        await db.collection('customerServiceTickets').doc(editingTicket.id).update({
                                                            orderNumber: editingTicket.orderNumber,
                                                            phoneNumber: editingTicket.phoneNumber,
                                                            country: editingTicket.country,
                                                            agentNotes: editingTicket.agentNotes
                                                        });
                                                        alert('‚úÖ Ticket updated successfully!');
                                                        loadAgentTickets();
                                                        setEditingTicket(null);
                                                    } catch (error) {
                                                        console.error('Error updating ticket:', error);
                                                        alert('‚ùå Failed to update ticket');
                                                    }
                                                }}
                                                style={{flex: 1}}
                                            >
                                                Save Changes
                                            </button>
                                            <button
                                                className="btn btn-secondary"
                                                onClick={() => setEditingTicket(null)}
                                                style={{flex: 1}}
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                        
                                        <div style={{marginTop: '2rem', padding: '1rem', background: 'rgba(96, 165, 250, 0.1)', borderRadius: '8px'}}>
                                            <p style={{fontSize: '0.875rem', color: '#94a3b8', marginBottom: '0.5rem'}}>
                                                <strong>Status:</strong> {editingTicket.status}
                                            </p>
                                            <p style={{fontSize: '0.875rem', color: '#94a3b8', marginBottom: '0'}}>
                                                <strong>Created:</strong> {editingTicket.timestamp ? new Date(editingTicket.timestamp).toLocaleString() : 'N/A'}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        )}
                    </div>
                );
            }
            
            // Manager View
            if (view === 'manager') {
                const escalatedTickets = tickets.filter(t => t.status === 'escalated');
                const resolvedTickets = tickets.filter(t => t.status === 'resolved');
                
                const displayTickets = getFilteredTickets();
                
                return (
                    <div>
                        <div className="header">
                            <h1>Manager Portal</h1>
                            <div className="header-right">
                                <button className="btn btn-secondary" onClick={() => setView('roleSelect')}>
                                    Back
                                </button>
                            </div>
                        </div>
                        
                        <div className="container">
                            {/* Tabs */}
                            <div className="tabs">
                                <button
                                    className={`tab ${managerTab === 'escalated' ? 'active' : ''}`}
                                    onClick={() => setManagerTab('escalated')}
                                >
                                    Escalated ({escalatedTickets.length})
                                </button>
                                <button
                                    className={`tab ${managerTab === 'pending' ? 'active' : ''}`}
                                    onClick={() => setManagerTab('pending')}
                                >
                                    Pending ({tickets.filter(t => t.status === 'pending').length})
                                </button>
                                <button
                                    className={`tab ${managerTab === 'resolved' ? 'active' : ''}`}
                                    onClick={() => setManagerTab('resolved')}
                                >
                                    Resolved ({resolvedTickets.length})
                                </button>
                                <button
                                    className={`tab ${managerTab === 'all' ? 'active' : ''}`}
                                    onClick={() => setManagerTab('all')}
                                >
                                    All Tickets ({tickets.length})
                                </button>
                            </div>
                            
                            {/* Info about resolved tickets retention */}
                            {managerTab === 'resolved' && (
                                <div style={{marginTop: '1rem', padding: '0.75rem 1rem', background: 'rgba(16, 185, 129, 0.1)', border: '1px solid rgba(16, 185, 129, 0.3)', borderRadius: '8px', fontSize: '0.875rem', color: '#94a3b8'}}>
                                    ‚ÑπÔ∏è Showing resolved tickets from the last 30 days. Older resolved tickets are automatically archived.
                                </div>
                            )}
                            
                            {/* Search and Filters */}
                            <div className="card" style={{marginTop: '1.5rem', padding: '1.5rem'}}>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem'}}>
                                    <div className="form-group" style={{marginBottom: 0}}>
                                        <label style={{fontSize: '0.875rem', marginBottom: '0.5rem'}}>Search</label>
                                        <input
                                            type="text"
                                            className="form-control"
                                            placeholder="Order #, Phone, Agent..."
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            style={{padding: '0.75rem'}}
                                        />
                                    </div>
                                    <div className="form-group" style={{marginBottom: 0}}>
                                        <label style={{fontSize: '0.875rem', marginBottom: '0.5rem'}}>Country</label>
                                        <select
                                            className="form-select"
                                            value={filterCountry}
                                            onChange={(e) => setFilterCountry(e.target.value)}
                                            style={{padding: '0.75rem'}}
                                        >
                                            <option value="All">All Countries</option>
                                            {COUNTRIES.map(c => (
                                                <option key={c} value={c}>{c}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="form-group" style={{marginBottom: 0}}>
                                        <label style={{fontSize: '0.875rem', marginBottom: '0.5rem'}}>Date Range</label>
                                        <select
                                            className="form-select"
                                            value={filterDate}
                                            onChange={(e) => setFilterDate(e.target.value)}
                                            style={{padding: '0.75rem'}}
                                        >
                                            <option value="All">All Time</option>
                                            <option value="Today">Today</option>
                                            <option value="Yesterday">Yesterday</option>
                                            <option value="Last 7 Days">Last 7 Days</option>
                                            <option value="Last 30 Days">Last 30 Days</option>
                                        </select>
                                    </div>
                                    <div className="form-group" style={{marginBottom: 0}}>
                                        <label style={{fontSize: '0.875rem', marginBottom: '0.5rem'}}>Sort By</label>
                                        <select
                                            className="form-select"
                                            value={sortOrder}
                                            onChange={(e) => setSortOrder(e.target.value)}
                                            style={{padding: '0.75rem'}}
                                        >
                                            <option value="newest">Newest First</option>
                                            <option value="oldest">Oldest First</option>
                                        </select>
                                    </div>
                                    {(searchQuery || filterCountry !== 'All' || filterDate !== 'All') && (
                                        <div style={{display: 'flex', alignItems: 'flex-end'}}>
                                            <button
                                                className="btn btn-secondary"
                                                onClick={() => {
                                                    setSearchQuery('');
                                                    setFilterCountry('All');
                                                    setFilterDate('All');
                                                }}
                                                style={{width: '100%'}}
                                            >
                                                Clear Filters
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Tickets Table */}
                            <div className="card">
                                {displayTickets.length === 0 ? (
                                    <div style={{textAlign: 'center', padding: '3rem', color: '#94a3b8'}}>
                                        <svg style={{width: '64px', height: '64px', margin: '0 auto 1rem', opacity: 0.5}} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <p>No tickets to display</p>
                                    </div>
                                ) : (
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date/Time</th>
                                                <th>Agent</th>
                                                <th>Phone</th>
                                                <th>Country</th>
                                                <th>Order #</th>
                                                <th>Type</th>
                                                <th>Issue</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {displayTickets.map(ticket => (
                                                <tr key={ticket.id}>
                                                    <td>
                                                        {ticket.timestamp ? new Date(ticket.timestamp).toLocaleString('en-US', {
                                                            month: 'short',
                                                            day: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        }) : 'N/A'}
                                                    </td>
                                                    <td>
                                                        <span style={{
                                                            padding: '0.25rem 0.5rem',
                                                            background: 'rgba(59, 130, 246, 0.1)',
                                                            borderRadius: '4px',
                                                            fontSize: '0.75rem',
                                                            fontWeight: 600,
                                                            color: '#60a5fa'
                                                        }}>
                                                            {ticket.agentUsername || 'Unknown'}
                                                        </span>
                                                    </td>
                                                    <td>{ticket.phoneNumber}</td>
                                                    <td>{ticket.country}</td>
                                                    <td style={{fontWeight: 600}}>{ticket.orderNumber}</td>
                                                    <td>
                                                        {ticket.orderPlaced ? (
                                                            <span style={{color: '#60a5fa'}}>Order Issue</span>
                                                        ) : (
                                                            <span style={{color: '#94a3b8'}}>General Inquiry</span>
                                                        )}
                                                    </td>
                                                    <td style={{fontSize: '0.8rem'}}>
                                                        {ticket.reasonForCall === 'add_remove' && 'Add/Remove Items'}
                                                        {ticket.reasonForCall === 'change_details' && 'Change Details'}
                                                        {ticket.reasonForCall === 'tracking' && 'Order Tracking'}
                                                        {ticket.reasonForCall === 'problem_delivered' && 'Delivered Problem'}
                                                        {ticket.generalQuery && 'General Inquiry'}
                                                    </td>
                                                    <td>
                                                        {ticket.status === 'escalated' && <span className="badge badge-escalated">Escalated</span>}
                                                        {ticket.status === 'resolved' && <span className="badge badge-resolved">Resolved</span>}
                                                        {ticket.status === 'pending' && <span className="badge badge-pending">Pending</span>}
                                                    </td>
                                                    <td>
                                                        <button
                                                            className="btn btn-primary btn-sm"
                                                            onClick={() => {
                                                                setSelectedTicket(ticket);
                                                                setManagerResolutionNotes('');
                                                            }}
                                                        >
                                                            View Details
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>
                        
                        {/* Ticket Detail Modal */}
                        {selectedTicket && (
                            <div style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(0,0,0,0.8)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 1000,
                                padding: '2rem'
                            }}>
                                <div style={{
                                    background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
                                    borderRadius: '12px',
                                    maxWidth: '800px',
                                    width: '100%',
                                    maxHeight: '90vh',
                                    overflow: 'auto',
                                    border: '1px solid rgba(71, 85, 105, 0.5)'
                                }}>
                                    <div style={{
                                        padding: '2rem',
                                        borderBottom: '1px solid rgba(71, 85, 105, 0.5)',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <h2 style={{fontSize: '1.5rem'}}>Ticket Details</h2>
                                        <button
                                            onClick={() => setSelectedTicket(null)}
                                            className="btn btn-secondary btn-sm"
                                        >
                                            Close
                                        </button>
                                    </div>
                                    
                                    <div style={{padding: '2rem'}}>
                                        <div className="ticket-detail">
                                            <div className="ticket-detail-row">
                                                <span className="ticket-detail-label">Date/Time:</span>
                                                <span className="ticket-detail-value">
                                                    {selectedTicket.timestamp ? new Date(selectedTicket.timestamp).toLocaleString() : 'N/A'}
                                                </span>
                                            </div>
                                            <div className="ticket-detail-row">
                                                <span className="ticket-detail-label">Agent:</span>
                                                <span className="ticket-detail-value">
                                                    <span style={{
                                                        padding: '0.25rem 0.75rem',
                                                        background: 'rgba(59, 130, 246, 0.15)',
                                                        borderRadius: '6px',
                                                        fontSize: '0.875rem',
                                                        fontWeight: 600,
                                                        color: '#60a5fa'
                                                    }}>
                                                        üë§ {selectedTicket.agentUsername || 'Unknown'}
                                                    </span>
                                                </span>
                                            </div>
                                            <div className="ticket-detail-row">
                                                <span className="ticket-detail-label">Phone:</span>
                                                <span className="ticket-detail-value">{selectedTicket.phoneNumber}</span>
                                            </div>
                                            <div className="ticket-detail-row">
                                                <span className="ticket-detail-label">Country:</span>
                                                <span className="ticket-detail-value">{selectedTicket.country}</span>
                                            </div>
                                            <div className="ticket-detail-row">
                                                <span className="ticket-detail-label">Order Number:</span>
                                                <span className="ticket-detail-value">{selectedTicket.orderNumber}</span>
                                            </div>
                                            <div className="ticket-detail-row">
                                                <span className="ticket-detail-label">Type:</span>
                                                <span className="ticket-detail-value">
                                                    {selectedTicket.orderPlaced ? 'Order Issue' : 'General Inquiry'}
                                                </span>
                                            </div>
                                            <div className="ticket-detail-row">
                                                <span className="ticket-detail-label">Status:</span>
                                                <span className="ticket-detail-value">
                                                    {selectedTicket.status === 'escalated' && <span className="badge badge-escalated">Escalated</span>}
                                                    {selectedTicket.status === 'resolved' && <span className="badge badge-resolved">Resolved</span>}
                                                    {selectedTicket.status === 'pending' && <span className="badge badge-pending">Pending</span>}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div style={{marginTop: '1.5rem'}}>
                                            <h3 style={{marginBottom: '1rem', fontSize: '1.125rem'}}>Conversation Summary</h3>
                                            <div className="ticket-detail">
                                                <p style={{color: '#cbd5e1', lineHeight: 1.6, whiteSpace: 'pre-wrap'}}>
                                                    {selectedTicket.agentNotes || 'No conversation summary provided'}
                                                </p>
                                            </div>
                                        </div>
                                        
                                        <div style={{marginTop: '1.5rem'}}>
                                            <h3 style={{marginBottom: '1rem', fontSize: '1.125rem'}}>Resolution Details</h3>
                                            <div className="ticket-detail">
                                                <p style={{color: '#cbd5e1', lineHeight: 1.6}}>
                                                    {selectedTicket.resolution || 'No resolution details available'}
                                                </p>
                                            </div>
                                        </div>
                                        
                                        {selectedTicket.refundAmount && (
                                            <div className="alert alert-warning" style={{marginTop: '1.5rem'}}>
                                                <strong>Refund Amount:</strong> ${selectedTicket.refundAmount.toFixed(2)}
                                            </div>
                                        )}
                                        
                                        {/* Manager Actions */}
                                        {selectedTicket.status === 'escalated' && (
                                            <div style={{marginTop: '2rem'}}>
                                                <h3 style={{marginBottom: '1rem', fontSize: '1.125rem'}}>Manager Actions</h3>
                                                
                                                {/* Resolution Details Text Area */}
                                                <div className="form-group" style={{marginBottom: '1.5rem'}}>
                                                    <label style={{fontWeight: 600, marginBottom: '0.5rem', display: 'block'}}>
                                                        Resolution Details *
                                                    </label>
                                                    <textarea
                                                        className="form-control"
                                                        value={managerResolutionNotes}
                                                        onChange={(e) => setManagerResolutionNotes(e.target.value)}
                                                        placeholder="Describe how you resolved this ticket (required before marking as resolved)..."
                                                        rows="4"
                                                        style={{
                                                            width: '100%',
                                                            minHeight: '100px',
                                                            resize: 'vertical'
                                                        }}
                                                    />
                                                    <p style={{fontSize: '0.75rem', color: '#94a3b8', marginTop: '0.5rem'}}>
                                                        Required to mark ticket as resolved
                                                    </p>
                                                </div>
                                                
                                                <div style={{display: 'flex', gap: '1rem', flexWrap: 'wrap'}}>
                                                    <button
                                                        className="btn btn-success"
                                                        onClick={() => {
                                                            if (!managerResolutionNotes.trim()) {
                                                                alert('‚ö†Ô∏è Please enter resolution details before marking as resolved');
                                                                return;
                                                            }
                                                            updateTicketStatus(selectedTicket.id, 'resolved', managerResolutionNotes);
                                                            setManagerResolutionNotes('');
                                                        }}
                                                        style={{flex: 1, minWidth: '200px'}}
                                                    >
                                                        ‚úì Mark as Resolved
                                                    </button>
                                                    <button
                                                        className="btn"
                                                        onClick={() => {
                                                            const notes = prompt('Add notes about why this is pending (optional):');
                                                            updateTicketStatus(selectedTicket.id, 'pending', notes || '');
                                                            setManagerResolutionNotes('');
                                                        }}
                                                        style={{
                                                            flex: 1,
                                                            minWidth: '200px',
                                                            background: 'linear-gradient(to right, #f59e0b, #d97706)',
                                                            color: 'white'
                                                        }}
                                                    >
                                                        ‚è≥ Mark as Pending
                                                    </button>
                                                </div>
                                                <p style={{marginTop: '0.75rem', fontSize: '0.875rem', color: '#94a3b8'}}>
                                                    üí° Mark as Pending if waiting for customer response, additional info, or follow-up
                                                </p>
                                            </div>
                                        )}
                                        
                                        {selectedTicket.status === 'pending' && (
                                            <div style={{marginTop: '2rem'}}>
                                                <h3 style={{marginBottom: '1rem', fontSize: '1.125rem'}}>Manager Actions</h3>
                                                
                                                {/* Resolution Details Text Area */}
                                                <div className="form-group" style={{marginBottom: '1.5rem'}}>
                                                    <label style={{fontWeight: 600, marginBottom: '0.5rem', display: 'block'}}>
                                                        Resolution Details *
                                                    </label>
                                                    <textarea
                                                        className="form-control"
                                                        value={managerResolutionNotes}
                                                        onChange={(e) => setManagerResolutionNotes(e.target.value)}
                                                        placeholder="Describe how you resolved this ticket (required before marking as resolved)..."
                                                        rows="4"
                                                        style={{
                                                            width: '100%',
                                                            minHeight: '100px',
                                                            resize: 'vertical'
                                                        }}
                                                    />
                                                    <p style={{fontSize: '0.75rem', color: '#94a3b8', marginTop: '0.5rem'}}>
                                                        Required to mark ticket as resolved
                                                    </p>
                                                </div>
                                                
                                                <div style={{display: 'flex', gap: '1rem', flexWrap: 'wrap'}}>
                                                    <button
                                                        className="btn btn-success"
                                                        onClick={() => {
                                                            if (!managerResolutionNotes.trim()) {
                                                                alert('‚ö†Ô∏è Please enter resolution details before marking as resolved');
                                                                return;
                                                            }
                                                            updateTicketStatus(selectedTicket.id, 'resolved', managerResolutionNotes);
                                                            setManagerResolutionNotes('');
                                                        }}
                                                        style={{flex: 1, minWidth: '200px'}}
                                                    >
                                                        ‚úì Mark as Resolved
                                                    </button>
                                                    <button
                                                        className="btn"
                                                        onClick={() => {
                                                            const notes = prompt('Add notes (optional):');
                                                            updateTicketStatus(selectedTicket.id, 'escalated', notes || '');
                                                            setManagerResolutionNotes('');
                                                        }}
                                                        style={{
                                                            flex: 1,
                                                            minWidth: '200px',
                                                            background: 'linear-gradient(to right, #ef4444, #dc2626)',
                                                            color: 'white'
                                                        }}
                                                    >
                                                        ‚ö†Ô∏è Re-escalate
                                                    </button>
                                                </div>
                                                <p style={{marginTop: '0.75rem', fontSize: '0.875rem', color: '#94a3b8'}}>
                                                    üí° Resolve when complete, or re-escalate if needs immediate attention
                                                </p>
                                            </div>
                                        )}
                                        
                                        {selectedTicket.status === 'resolved' && (
                                            <div style={{marginTop: '2rem', padding: '1rem', background: 'rgba(16, 185, 129, 0.1)', border: '1px solid rgba(16, 185, 129, 0.3)', borderRadius: '8px'}}>
                                                <p style={{color: '#10b981', fontSize: '0.875rem', marginBottom: '0.5rem'}}>
                                                    ‚úì This ticket has been resolved
                                                </p>
                                                {selectedTicket.managerNotes && (
                                                    <p style={{color: '#cbd5e1', fontSize: '0.875rem'}}>
                                                        Manager Notes: {selectedTicket.managerNotes}
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
        }
        
        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>
